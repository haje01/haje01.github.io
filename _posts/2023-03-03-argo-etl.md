---
layout: post
title: "Argo Events ì™€ Workflows ë¥¼ ì´ìš©í•œ ETL"
description:
date: 2023-03-03
tags: [draft]
---

# Argo Events ì™€ Workflows ë¥¼ ì´ìš©í•œ ETL

ì´ ê¸€ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì—ì„œ ì›ë³¸ ë°ì´í„°ê°€ ì €ì¥ëœ íŒŒì¼ì„ ê°€ì ¸ì™€ ì •ë¦¬í•˜ëŠ” íš¨ìœ¨ì ì¸ ë°©ë²•ì— ëŒ€í•´ ì†Œê°œí•œë‹¤.

ì»¨í…Œì´ë„ˆí™”ì™€ ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ìµœê·¼ IT ì—…ê³„ì—ì„œ ë§¤ìš° ì¤‘ìš”í•œ ê¸°ìˆ  ì¤‘ í•˜ë‚˜ì´ë‹¤. ì»¨í…Œì´ë„ˆí™”ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹ ë¥´ê³  ì‰½ê²Œ ë°°í¬í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ë©°, ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ íˆ´ë¡œ, ì»¨í…Œì´ë„ˆë¥¼ ì‰½ê²Œ ê´€ë¦¬í•˜ê³  ìŠ¤ì¼€ì¼ë§í•˜ëŠ” ë“±ì˜ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

ETL(Extract, Transform, Load)ì€ ë°ì´í„° ë¶„ì„ ë° ì²˜ë¦¬ë¥¼ ìœ„í•œ ì¤‘ìš”í•œ ê³¼ì •ì´ë‹¤. ì´ ê³¼ì •ì—ì„œëŠ” ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ê³ , ë³€í™˜í•˜ì—¬ í•„ìš”í•œ í˜•ì‹ìœ¼ë¡œ ê°€ê³µí•œ ë‹¤ìŒ, ë¡œë“œí•˜ì—¬ ì €ì¥ì†Œì— ì €ì¥í•˜ê²Œ ëœë‹¤. ì´ëŸ¬í•œ ETL ê³¼ì •ì€ ë°ì´í„° ì²˜ë¦¬ì˜ í•µì‹¬ì´ë‹¤.

Argo Eventsì™€ Workflowsë¥¼ ì´ìš©í•˜ë©´, ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì—ì„œ ETL ê³¼ì •ì„ ìë™í™”í•˜ê³ , ì‰½ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤. Argo Eventsë¥¼ ì‚¬ìš©í•˜ë©´, ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ ì†ŒìŠ¤ë¡œë¶€í„° ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•˜ê³ , Workflowë¥¼ ì‹œì‘í•  ìˆ˜ ìˆë‹¤. WorkflowëŠ” ETL ê³¼ì •ì˜ ê° ë‹¨ê³„ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤€ë‹¤. ì´ëŸ¬í•œ ë°©ì‹ìœ¼ë¡œ Argo Eventsì™€ Workflowsë¥¼ ì´ìš©í•˜ë©´, ë°ì´í„° ì²˜ë¦¬ ê³¼ì •ì„ ìë™í™”í•˜ê³ , ë”ìš± ë¹ ë¥´ê³  ì •í™•í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, S3 ë²„í‚·ì— ìƒˆë¡œìš´ íŒŒì¼ì´ ì—…ë¡œë“œë˜ë©´, Argo EventsëŠ” ì´ë¥¼ ê°ì§€í•˜ê³ , ìƒˆë¡œìš´ Workflowë¥¼ ì‹œì‘í•œë‹¤. WorkflowëŠ” íŒŒì¼ì„ ì¶”ì¶œí•˜ê³ , í•„ìš”í•œ ë³€í™˜ì„ ìˆ˜í–‰í•œ ë‹¤ìŒ, ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì—¬ ì €ì¥ì†Œì— ì €ì¥í•œë‹¤. ì´ëŸ¬í•œ ë°©ì‹ìœ¼ë¡œ Argo Eventsì™€ Workflowsë¥¼ ì´ìš©í•˜ë©´, ETL ê³¼ì •ì„ ë”ìš± íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìœ¼ë©°, ë°ì´í„° ë¶„ì„ ë° ì²˜ë¦¬ ê³¼ì •ì„ ìë™í™”í•  ìˆ˜ ìˆë‹¤.

ì´ ê¸€ì—ì„œëŠ” ì˜ˆì œë¥¼ í†µí•´ ìœ„ì˜ ê³¼ì •ì„ ì‚´í´ë³´ê² ë‹¤. ë¨¼ì € í•„ìš”í•œ ê°œë… ë° ì¤€ë¹„ ê³¼ì •ë¶€í„° ì‹œì‘í•˜ê² ë‹¤. 

![Argo Events Overview](/assets/2023-03-03-18-00-48.png)


## ì¤€ë¹„ 

> ì´ ê¸€ì—ì„œëŠ” Linux í™˜ê²½ í˜¸ìŠ¤íŠ¸ë¥¼ ì „ì œë¡œ ì„¤ëª…í•œë‹¤. 

### ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½

ì¼ë‹¨ ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì´ í•„ìš”í•œë‹¤. ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ë‹¤ì–‘í•œ ë°°í¬íŒì´ ìˆìœ¼ë‚˜, ì˜ˆì œì—ì„œëŠ” ë¡œì»¬ì— minikube ê°€ ì„¤ì¹˜ëœ ê²ƒì„ ê°€ì •í•˜ê³  ì§„í–‰í•˜ê² ë‹¤. ì„¤ì¹˜ ë°©ë²•ì€ [ì´ê³³](https://minikube.sigs.k8s.io/docs/start/) ì„ ì°¸ê³ í•˜ê¸° ë°”ë€ë‹¤.

ë˜í•œ, ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì— ë‹¤ì–‘í•œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ê¸° ìœ„í•´ íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €ì¸ [Helm](https://helm.sh/) ì˜ ì„¤ì¹˜ê°€ í•„ìš”í•˜ë‹¤.

### Argo Events ì„¤ì¹˜

> Argo Events ì˜ ìµœì‹  ë²„ì „ì€ ë‹¤ìŒ ë§í¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
> https://github.com/argoproj/argo-events/releases

ì—¬ê¸°ì„œëŠ” ë²„ì „ 1.7.6 ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…í•œë‹¤. Helm ì„ í†µí•´ Argo ì˜ ì°¨íŠ¸ë¡œ ì„¤ì¹˜í•œë‹¤.

```
helm repo add argo https://argoproj.github.io/argo-helm
helm install argo/events
```

ì¶”ê°€ë¡œ ì´ì–´ì„œ ì„¤ëª…í•  EventBus ì˜ ì„¤ì¹˜ê°€ í•„ìš”í•˜ë‹¤.

```yaml
kubectl apply -f - <<EOF
apiVersion: argoproj.io/v1alpha1
kind: EventBus
metadata:
  name: default
spec:
  nats:
    native:
      # ìµœì†Œ 3ê°œ ì´ìƒ
      replicas: 3
      # ì¸ì¦ ì „ëµ
      auth: none
EOF
```

### Argo Workflows ì„¤ì¹˜

> Argo Workflows ì˜ ìµœì‹  ë²„ì „ì€ ë‹¤ìŒ ë§í¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
> https://github.com/argoproj/argo-workflows/releases

ì—¬ê¸°ì„œëŠ” ë²„ì „ 3.4.5 ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…í•œë‹¤. Argo Workflows ëŠ” CLI ëª…ë ¹ê³¼ ì»¨íŠ¸ë¡¤ëŸ¬ ë° ì„œë²„ ì„¤ì¹˜ë¡œ ë‚˜ë‰˜ëŠ”ë°, ë¨¼ì € ë‹¤ìŒê³¼ ê°™ì´ CLI ë¥¼ ì„¤ì¹˜í•œë‹¤.

```bash
# Download the binary
curl -sLO https://github.com/argoproj/argo-workflows/releases/download/v3.4.5/argo-linux-amd64.gz

# Unzip
gunzip argo-linux-amd64.gz

# Make binary executable
chmod +x argo-linux-amd64

# Move binary to path
mv ./argo-linux-amd64 /usr/local/bin/argo

# Test installation
argo version
```

ì»¨íŠ¸ë¡¤ëŸ¬ ë° ì„œë²„ëŠ” Helm ì„ í†µí•´ Bitnami ì˜ ì°¨íŠ¸ë¡œ ì„¤ì¹˜í•œë‹¤.

```bash
helm repo add bitnami https://charts.bitnami.com/bitnami
helm install awf bitnami/argo-workflows --set auth.enabled=false --set postgresql.enabled=false
```

Argo Workflows UI ë¡œê·¸ì¸ì„ ìœ„í•´ í† í°ì´ í•„ìš”í•˜ë‹¤. ìµœì‹  K8S ì—ì„œëŠ” Service Account ì— ê¸°ë³¸ í† í°ì´ ì—†ê¸°ì—, ë‹¤ìŒì²˜ëŸ¼ `kubernetes.io/service-account.name` ì–´ë…¸í…Œì´ì…˜ì´ ìˆëŠ” Secret ì„ ë§Œë“¤ê³  ,

```
kubectl apply -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: awf-argo-workflows-server-secret
  annotations:
    kubernetes.io/service-account.name: awf-argo-workflows-server
type: kubernetes.io/service-account-token
EOF
```

ì ì‹œ í›„ì— ë‹¤ìŒì²˜ëŸ¼ í† í°ì„ ì–»ì„ ìˆ˜ ìˆë‹¤. 

```
ARGO_TOKEN="Bearer $(kubectl get secret awf-argo-workflows-server-secret -o=jsonpath='{.data.token}' | base64 --decode)"
echo $ARGO_TOKEN
```

UI í˜ì´ì§€ ì ‘ì†ì„ ìœ„í•´ì„œ ë‹¤ìŒê³¼ ê°™ì´ í¬íŠ¸í¬ì›Œë”©ì´ í•„ìš”í•˜ë‹¤.

```
kubectl port-forward --namespace default svc/awf-argo-workflows-server 8046:80
```

ì›¹ë¸Œë¼ìš°ì €ì—ì„œ `http://localhost:8046` ì£¼ì†Œë¡œ ì ‘ì†í•˜ê³ , ì–»ì–´ë‘” í† í°ì„ ì´ìš©í•´ ë¡œê·¸ì¸í•˜ë©´ ëœë‹¤.

![Workflow UI](/assets/2023-03-08-13-25-40.png)

### ì•„í‹°íŒ©íŠ¸ ì €ì¥ì†Œ ì¤€ë¹„ 

Argo Workflows ì—ì„œ ì•„í‹°íŒ©íŠ¸ (Artifact) ëŠ” ì‘ì—…ì˜ ê²°ê³¼ë¡œ ìƒì„±ë˜ëŠ” ë¦¬ì†ŒìŠ¤ë‚˜ íŒŒì¼ì„ ë§í•œë‹¤. ì‘ì—…ê°„ ê²°ê³¼ë¬¼ì„ ì•„í‹°íŒ©íŠ¸ì˜ í˜•íƒœë¡œ ê³µìœ í•  ìˆ˜ ìˆë‹¤. 

ì•„í‹°íŒ©íŠ¸ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ë¨¼ì € [ì•„í‹°íŒ©íŠ¸ ì €ì¥ì†Œ (Artifact Repository)](https://argoproj.github.io/argo-workflows/configure-artifact-repository/) ë¥¼ ì„¤ì •í•˜ì—¬ì•¼ í•œë‹¤. S3, Azure Blob, HDFS ë“± ë‹¤ì–‘í•œ ì•„í‹°íŒ©íŠ¸ ì €ì¥ì†Œ íƒ€ì…ì´ ìˆëŠ”ë°, ì—¬ê¸°ì„œëŠ” [MinIO](https://min.io/) ë¥¼ ì´ìš©í•˜ê² ë‹¤. 

ì•ì—ì„œì™€ ë§ˆì°¬ê°€ì§€ë¡œ [Helm](https://helm.sh/) ì„ í†µí•´ Bitnami ì˜ ì°¨íŠ¸ë¡œ ì„¤ì¹˜í•œë‹¤.

```
helm install minio bitnami/minio
```

ì„¤ì¹˜ í›„ MinIO ë£¨íŠ¸ìœ ì €ì˜ ì´ë¦„ê³¼ ì•”í˜¸ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì–»ì„ ìˆ˜ ìˆë‹¤.
```
# MinIO ë£¨íŠ¸ìœ ì € ì´ë¦„
kubectl get secret --namespace default minio -o jsonpath="{.data.root-user}" | base64 -d
# MinIO ë£¨íŠ¸ìœ ì € ì•”í˜¸ 
kubectl get secret --namespace default minio -o jsonpath="{.data.root-password}" | base64 -d
```

ì´ì œ minikube ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒì²˜ëŸ¼ MinIO UI ì˜ ì ‘ì† URL ì„ ì–»ëŠ”ë‹¤.
```
$ minikube service --url minio
ğŸ˜¿  service default/minio has no node port
http://127.0.0.1:44337
http://127.0.0.1:43593
```

ì•„ë˜ì— ì¶œë ¥ëœ URL ë¡œ ì ‘ì†í•œ í›„ ì•ì—ì„œ ì–»ì–´ë‘” ë£¨íŠ¸ ìœ ì € ì´ë¦„ê³¼ ì•”í˜¸ë¡œ ë¡œê·¸ì¸í•œë‹¤. 

![MinIO Login](/assets/2023-03-08-13-45-51.png)

ì´í›„ `Create Bucket` ë§í¬ë¥¼ ëˆŒëŸ¬ `my-bucket` ì´ë¼ëŠ” ì´ë¦„ì˜ ë²„í‚·ì„ ë§Œë“ ë‹¤.

![Artifact Bucket](/assets/2023-03-08-13-46-51.png)

ì‹¤ì œ ì›Œí¬í”Œë¡œìš°ê°€ ì‚¬ìš©í•  ì €ì¥ì†ŒëŠ” [ì•„í‹°íŒ©íŠ¸ ì €ì¥ì†Œ ë ˆí¼ëŸ°ìŠ¤](https://argoproj.github.io/argo-workflows/artifact-repository-ref/) ë¡œ ì„¤ì •í•˜ëŠ”ë°, ê·¸ê²ƒì€ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ `ConfigMap` ì„ í†µí•´ ë§Œë“¤ì–´ì§„ë‹¤. ë‹¤ìŒê³¼ ê°™ì´ ì‹¤í–‰í•˜ë©´ ëœë‹¤.

```yaml
kubectl apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: artifact-repositories
  annotations:
    workflows.argoproj.io/default-artifact-repository: default-minio-repository
data:
  default-minio-repository: |
    s3:
      bucket: my-bucket
      endpoint: minio:9000
      insecure: true
      accessKeySecret:
        name: minio
        key: root-user
      secretKeySecret:
        name: minio
        key: root-password
EOF
```

ëª¨ë“  ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìœ¼ë©´, ì§€ê¸ˆë¶€í„° Argo Events ë° Argo Workflows ì˜ ê¸°ë³¸ ê°œë…ì„ ì‚´í´ë³´ê² ë‹¤. 

## Argo Events ì†Œê°œ 

ì „í†µì ìœ¼ë¡œ ë§ì€ ì¡°ì§ì—ì„œ íŠ¹ì • ì‹œê°„ì´ë˜ë©´ ì›ë³¸ ë°ì´í„°ê°€ ê°±ì‹ ëœ ê²ƒì„ ê°€ì •í•˜ê³ , ê°€ì ¸ì™€ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì„ ë§ì´ ì‚¬ìš©í•˜ì˜€ë‹¤. ì´ëŠ” ì¼ê²¬ ë‹¨ìˆœí•´ ë³´ì´ë‚˜ ë¬¸ì œì ì„ ë‚´í¬í•˜ê³  ìˆë‹¤. íŠ¹íˆ ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ì— ë¬¸ì œê°€ í¬ë‹¤:

- ì§€ì • ì‹œê°„ì— ì›ë³¸ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ë¶ˆì™„ì „í•œ ê²½ìš°
- ì§€ì • ì‹œê°„ì— ETL ëœ íŒŒì¼ì˜ ë‚´ìš©ì´ ê°±ì‹ ë˜ì–´ ë‹¤ì‹œ ì˜¬ë¼ì˜¤ëŠ” ê²½ìš°
- ì§€ì • ì‹œê°„ì˜ ETL ì‘ì—… ì¢…ë£Œ í›„ ì¶”ê°€ íŒŒì¼ì´ ì˜¬ë¼ì˜¤ëŠ” ê²½ìš°

ì´ëŸ° ë¬¸ì œê°€ ë¹ˆë²ˆí•œ ê²½ìš° ëŒ€ì‘ì„ ìœ„í•´ ëª¨ë‹ˆí„°ë§ ë° ìˆ˜ë™ ì¬ì‘ì—…ì„ ì‹¤ì‹œí•˜ê³¤ í•˜ëŠ”ë°, ì‹œê°„ ë° ì¸ì  ë¦¬ì†ŒìŠ¤ê°€ ì†Œëª¨ê°€ í¬ë‹¤.

ë¬¸ì œë¥¼ ê·¼ì›ì ìœ¼ë¡œ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ì›ë³¸ ë°ì´í„°ê°€ ì˜¬ë¼ì˜¤ëŠ” ì´ë²¤íŠ¸ë¥¼ ì¸ì‹í•˜ê³ , í•´ë‹¹ ì´ë²¤íŠ¸ ë°œìƒì‹œ ì‘ì—…ì„ ì§„í–‰í•˜ëŠ” ì´ë²¤íŠ¸ ê¸°ë°˜ (Event-Driven) ë°©ì‹ì˜ ë„ì…ì´ í•„ìš”í•œë‹¤. ì´ë ‡ê²Œ í•˜ë©´ íŒŒì¼ì´ ì˜ˆìƒë³´ë‹¤ ëŠ¦ê²Œ ì˜¬ë¼ì˜¤ê±°ë‚˜, ë°”ë€ ë‚´ìš©ìœ¼ë¡œ ë‹¤ì‹œ ì˜¬ë¼ì˜¤ëŠ” ê²½ìš°ì—ë„ ìë™ìœ¼ë¡œ ì¬ì‘ì—…ì´ ì§„í–‰ë˜ê¸° ë•Œë¬¸ì´ë‹¤.

Argo Events ëŠ” ì´ëŸ¬í•œ ì´ë²¤íŠ¸ ê¸°ë°˜ ì²˜ë¦¬ë¥¼ ìœ„í•œ í›Œë¥­í•œ íˆ´ë¡œ, ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì„± ìš”ì†Œë¥¼ ê°€ì§„ë‹¤.

### Event ì™€ EventSource

Argo Eventsì—ì„œ EventëŠ” êµ¬ì²´ì ì¸ ì´ë²¤íŠ¸ë¥¼ ì˜ë¯¸í•˜ë©°, EventSourceëŠ” í•˜ë‚˜ ì´ìƒì˜ Event íƒ€ì…ì„ í†µí•´ ê³ ìˆ˜ì¤€ì˜ ì´ë²¤íŠ¸ë¥¼ ì •ì˜í•˜ëŠ” ì—­í• ì„ í•œë‹¤. 

> ë‹¨ì¼ ì´ë²¤íŠ¸ë§Œ ê°€ì§€ëŠ” ì´ë²¤íŠ¸ì†ŒìŠ¤ì˜ ê²½ìš°, ê·¸ ì´ë²¤íŠ¸ íƒ€ì…ì´ ì´ë²¤íŠ¸ì†ŒìŠ¤ì˜ íƒ€ì…ìœ¼ë¡œ ë¶ˆë ¤ì§€ê³¤ í•œë‹¤.

ì•„ë˜ì™€ ê°™ì€ ì´ë²¤íŠ¸ íƒ€ì…ì´ ìˆë‹¤:

- ë‹¬ë ¥
- íŒŒì¼
- HTTP (ì›¹í›…)
- AWS S3, SNS, SQS
- ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤
- Kafka
- GitHub / GitLab

> ì´ ì™¸ì—ë„ ë‹¤ì–‘í•œ íƒ€ì…ì´ ìˆìœ¼ë©°, í•„ìš”í•˜ë‹¤ë©´ ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ì†ŒìŠ¤ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
> https://argoproj.github.io/argo-events/eventsources/generic/

### Sensor ì™€ Trigger

Argo Eventsì—ì„œ SensorëŠ” ìì‹ ì´ ì˜ì¡´í•˜ëŠ” EventSource ì—ì„œ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ìì‹ ì—ê²Œ ë“±ë¡ëœ í•˜ë‚˜ ì´ìƒì˜ Triggerë¥¼ í™œì„±í™”í•˜ëŠ” ì—­í• ì„ í•œë‹¤. TriggerëŠ” ë°œìƒí•œ ì´ë²¤íŠ¸ ë§¤ê°œë³€ìˆ˜ì™€ í™˜ê²½ ì •ë³´ë¥¼ ì°¸ê³ í•´ ì§€ì •ëœ ë™ì‘ì„ ì‹¤í–‰í•œë‹¤. 

> ë‹¨ì¼ íŠ¸ë¦¬ê±°ë§Œ ê°€ì§€ëŠ” ì„¼ì„œì˜ ê²½ìš°, ê·¸ íŠ¸ë¦¬ê±° íƒ€ì…ì´ ì„¼ì„œì˜ íƒ€ì…ìœ¼ë¡œ ë¶ˆë ¤ì§€ê³¤ í•œë‹¤.

ì•„ë˜ì™€ ê°™ì€ íŠ¸ë¦¬ê±° íƒ€ì…ì´ ìˆë‹¤:

- HTTP 
- Argo Workflows
- AWS Lambda
- ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤
- Kafka ë©”ì‹œì§€
- ë¡œê·¸ (ë””ë²„ê¹… ìš©)

> ì´ ì™¸ì—ë„ ë‹¤ì–‘í•œ íƒ€ì…ì´ ìˆìœ¼ë©°, í•„ìš”í•˜ë‹¤ë©´ ì»¤ìŠ¤í…€ íŠ¸ë¦¬ê±°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤. 
> https://argoproj.github.io/argo-events/sensors/triggers/build-your-own-trigger/

í•˜ë‚˜ì˜ Sensorê°€ í•˜ë‚˜ ì´ìƒì˜ Triggerë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ ë‹¤ì–‘í•œ Workflowë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

### EventBus

Argo Events ì—ì„œ EventBus ëŠ” ì´ë²¤íŠ¸ ì†ŒìŠ¤ë¥¼ ì„¼ì„œë¡œ ì „ë‹¬í•´ì£¼ëŠ” ì»¤ìŠ¤í…€ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ì´ë‹¤. ê·¸ë ‡ê²Œ í•˜ê¸° ìœ„í•´ EventBus ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì— ë§Œë“¤ì–´ì ¸ì•¼ í•œë‹¤. 

> ì´ë²¤íŠ¸ë²„ìŠ¤ëŠ” ì˜¤í”ˆì†ŒìŠ¤ ê²½ëŸ‰ ë©”ì‹œì§€ ë¸Œë¡œì»¤ì¸ [NATS](https://docs.nats.io/) ë¥¼ ì´ìš©í•´ êµ¬í˜„ë˜ì—ˆë‹¤.

---

ì´ì œ HTTP í¬ìŠ¤íŠ¸ë¥¼ í†µí•´ì„œ ì›Œí¬í”Œë¡œìš°ë¥¼ íŠ¸ë¦¬ê±°í•˜ëŠ” ì˜ˆì œë¥¼ ì‚´í´ë³´ì.

ì•„ë˜ëŠ” ì›¹í›… ì´ë²¤íŠ¸ì†ŒìŠ¤ íŒŒì¼ `webhook.yaml` ì´ë‹¤. 

```yaml
apiVersion: argoproj.io/v1alpha1
kind: EventSource
metadata:
  name: webhook
spec:
  service:
    ports:
      - port: 12000
        targetPort: 12000
  webhook:
    # ì´ë²¤íŠ¸ ì†ŒìŠ¤ëŠ” í•˜ë‚˜ ì´ìƒì˜ HTTP ì„œë²„ë¥¼ ë„ìš¸ ìˆ˜ ìˆë‹¤.
    example:
      # HTTP ì„œë²„ í¬íŠ¸
      port: "12000"
      # ë¦¬ìŠ¨í•  ì—”ë“œí¬ì¸íŠ¸ 
      endpoint: /example
      # í—ˆìš©ë˜ëŠ” HTTP ë©”ì†Œë“œ
      method: POST
```

ì´ë¥¼ ì´ìš©í•´ ë‹¤ìŒì²˜ëŸ¼ ì›¹í›… ì´ë²¤íŠ¸ì†ŒìŠ¤ë¥¼ ìƒì„±í•œë‹¤. 

```
kubectl apply -f webhook.yaml
```

ì•„ë˜ëŠ” ë¡œê·¸ ì„¼ì„œ íŒŒì¼ `log.yaml` ì´ë‹¤.

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: log
spec:
  dependencies:
  # ì´ ì„¼ì„œê°€ ì˜ì¡´í•˜ëŠ” ì´ë²¤íŠ¸ ì†ŒìŠ¤ 
  - name: test-dep
    eventSourceName: webhook
    eventName: example
  triggers:
  - template:
      name: log-trigger
      log:
        intervalSeconds: 1        
```

ì´ë¥¼ ì´ìš©í•´ ë‹¤ìŒì²˜ëŸ¼ ë¡œê·¸ ì„¼ì„œë¥¼ ìƒì„±í•œë‹¤. 

```
kubectl apply -f log.yaml
```

ì´ì œ ë‹¤ìŒê³¼ ê°™ì´ ì§€ê¸ˆê¹Œì§€ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

```
$ kubectl get pods
NAME                                                 READY   STATUS    RESTARTS   AGE
aev-argo-events-controller-manager-b99485cdf-ql8z2   1/1     Running   0          5m38s
awf-argo-workflows-controller-75686d754d-msrbg       1/1     Running   0          2m19s
awf-argo-workflows-server-588d6686bb-6qc5z           1/1     Running   0          2m19s
eventbus-default-stan-0                              2/2     Running   0          4m5s
eventbus-default-stan-1                              2/2     Running   0          3m53s
eventbus-default-stan-2                              2/2     Running   0          3m51s
log-sensor-rp56d-f8b5b694-bs99c                      1/1     Running   0          9s
webhook-eventsource-cfkdt-7fc944c598-mxlb9           1/1     Running   0          71s
```

> íŒŒë“œ ì´ë¦„ì— ì„ì˜ì˜ ë¬¸ìì—´ì´ ë¶™ì–´ìˆëŠ”ë°, ì´ ë¶€ë¶„ì€ ì‹¤ì œ ì‹¤ìŠµì—ì„œ ë‚˜ì˜¤ëŠ” ê²ƒìœ¼ë¡œ ëŒ€ì²´í•˜ì. 

ì›¹í›… ì´ë²¤íŠ¸ì†ŒìŠ¤ `webhook-eventsource-cfkdt-7fc944c598-mxlb9` íŒŒë“œì™€ ë¡œê·¸ ì„¼ì„œ `log-sensor-rp56d-f8b5b694-bs99c` íŒŒë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì´ë²¤íŠ¸ë²„ìŠ¤ëŠ” ê³ ê°€ìš©ì„±ì„ ìœ„í•´ 3ê°œ ì´ìƒì˜ íŒŒë“œë¥¼ ì´ìš©í•œë‹¤.

í˜¸ìŠ¤íŠ¸ì—ì„œ POST ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•´ í¬íŠ¸í¬ì›Œë”©ì„ í•œë‹¤. 

```
kubectl port-forward $(kubectl get pod -l eventsource-name=webhook -o name) 12000:12000
```

ì´ì œ ì›¹í›… ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚¤ë©´, ì´ë²¤íŠ¸ -> ì´ë²¤íŠ¸ ì†ŒìŠ¤ -> ì´ë²¤íŠ¸ë²„ìŠ¤ -> ì„¼ì„œ -> íŠ¸ë¦¬ê±°ì˜ ìˆœìœ¼ë¡œ ì§„í–‰ë  ê²ƒì´ë‹¤. í™•ì¸ì„ ìœ„í•´ ë‹¤ìŒì²˜ëŸ¼ ë¡œê·¸ ì„¼ì„œ íŒŒë“œì˜ ë¡œê·¸ë¥¼ ëª¨ë‹ˆí„°ë§ í•œë‹¤.

```
kubectl logs -f log-sensor-rp56d-f8b5b694-bs99c
```

ì´ì œ ë‹¤ìŒì²˜ëŸ¼ ì—”ë“œí¬ì¸íŠ¸ë¡œ POST ë¥¼ í˜¸ì¶œí•˜ë©´,
```
curl -d '{"message":"this is my first webhook"}' -H "Content-Type: application/json" -X POST http://localhost:12000/example
```

íŠ¸ë¦¬ê±°ê°€ ì‹¤í–‰ëœ ê²ƒì„ ë¡œê·¸ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```
{"level":"info","ts":1678248798.7899067,"logger":"argo-events.sensor","caller":"log/log.go:46","msg":"{\"header\":{\"Accept\":[\"*/*\"],\"Content-Length\":[\"38\"],\"Content-Type\":[\"application/json\"],\"User-Agent\":[\"curl/7.68.0\"]},\"body\":{\"message\":\"this is my first webhook\"}}","sensorName":"log","triggerName":"log-trigger","triggerType":"Log",
...
```

## Argo Workflows ì†Œê°œ

Argo WorkflowsëŠ” ë°ì´í„° ì²˜ë¦¬ì™€ ê°™ì€ ì¼ê´„ ì²˜ë¦¬ ì‘ì—…ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ”ë°, Argo Eventsê°€ ê°ì§€í•œ ì´ë²¤íŠ¸ë¥¼ ì‹¤ì§ˆì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ì›Œí¬í”Œë¡œìš°ë¥¼ êµ¬ì„±í•˜ê²Œ ëœë‹¤.

ì›Œí¬í”Œë¡œìš°ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ Job ë¦¬ì†ŒìŠ¤ì™€ ë¹„ìŠ·í•œ êµ¬ì„±ì˜ yaml íŒŒì¼ë¡œ ì‘ì„±í•œë‹¤. 

### ë‹¨ìˆœí•œ ì›Œí¬í”Œë¡œìš° ì˜ˆì œì™€ ì£¼ìš” ê°œë… 

ë‹¤ìŒì€ ê°„ë‹¨í•œ ì›Œí¬í”Œë¡œìš°ì˜ ì˜ˆì´ë‹¤.

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: hello-world-  # ì›Œí¬í”Œë¡œìš° ì´ë¦„ ìƒì„±ìš© ì ‘ë‘ì–´ 
spec:
  # ì‚¬ìš©í•  í…œí”Œë¦¿ì„ ì •ì˜ 
  templates:
  - name: whalesay            # `whalesay` í…œí”Œë¦¿ ì •ì˜ 
    container:
      image: docker/whalesay
      command: [cowsay]
      args: ["hello world"]   
  # ìœ„ í…œí”Œë¦¿ìœ¼ë¡œ ì‹œì‘
  entrypoint: whalesay        
```

ìœ„ íŒŒì¼ì„ `hello-world.yaml` ë¡œ ì €ì¥í•˜ê³  ë‹¤ìŒì²˜ëŸ¼ CLI ë¥¼ í†µí•´ ì ìš©í•œë‹¤. 

```
argo submit --watch hello-world.yaml
```

`--watch` ëŠ” ì›Œí¬í”Œë¡œìš°ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ì •ë³´ë¥¼ ê³„ì† í‘œì‹œí•œë‹¤. 

> ì•„ë˜ì™€ ê°™ì´ `kubectl` ì„ ì´ìš©í•´ë„ ëœë‹¤.
> ```
> kubectl create -f hello-world.yaml
> ```

ë‹¤ë¥¸ ì—ëŸ¬ê°€ ì—†ë‹¤ë©´, ì„±ê³µì ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ê°€ ë§Œë“¤ì–´ì§„ ê²ƒì´ë‹¤. CLI ë¥¼ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

```
$ argo list

NAME                STATUS      AGE   DURATION   PRIORITY   MESSAGE
hello-world-lncsd   Succeeded   2m    30s        0
```

ì›Œí¬í”Œë¡œìš° ì´ë¦„ì€ ì•ì„œ `generateName` ìœ¼ë¡œ ê¸°ìˆ í•œ `hello-world-` ë’¤ì— ëœë¤ ë¬¸ìì—´ì´ ë¶™ì€ í˜•íƒœì´ë‹¤. 

Argo Workflows UI í˜ì´ì§€ì—ì„œë„ ìƒì„±ëœ ì›Œí¬í”Œë¡œìš° ì •ë³´ì™€ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![Workflow Info](/assets/2023-03-08-13-38-35.png)

![Workflow logs](/assets/2023-03-08-13-39-05.png)

> ë§Œì•½ UI ì—ì„œ ì›Œí¬í”Œë¡œìš°ê°€ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤ë©´, NAMESPACE ë€ì„ í™•ì¸í•´ë³´ì.

ìœ„ ì˜ˆì œì—ì„œ ì²˜ëŸ¼ `templates` ë¸”ëŸ­ ì•„ë˜ì— í•˜ë‚˜ ì´ìƒì˜ ì‘ì—…ìš© í…œí”Œë¦¿ì„ ì •ì˜í•  ìˆ˜ ìˆë‹¤. í…œí”Œë¦¿ì—ëŠ” ëª¨ë‘ 6ê°€ì§€ íƒ€ì…ì´ ìˆëŠ”ë°, ìœ„ ì˜ˆëŠ” ì»¨í…Œì´ë„ˆ í…œí”Œë¦¿ì„ ì´ìš©í•œ ê²ƒì´ë‹¤. í…œí”Œë¦¿ íƒ€ì…ì€ í¬ê²Œ ì •ì˜ìš© í…œí”Œë¦¿ê³¼ í˜¸ì¶œìš© í…œí”Œë¦¿ìœ¼ë¡œ ë‚˜ë‰œë‹¤.

### ì •ì˜ í…œí”Œë¦¿

ì •ì˜ (Definition) í…œí”Œë¦¿ì€ êµ¬ì²´ì ì¸ ì‘ì—…ì„ ì •ì˜í•˜ê¸° ìœ„í•´ ì‚¬ìš©ëœë‹¤.

#### Container í…œí”Œë¦¿ 

ì»¨í…Œì´ë„ˆ í…œí”Œë¦¿ì€ ê°€ì¥ ìì£¼ ì‚¬ìš©ë˜ëŠ” íƒ€ì…ìœ¼ë¡œ, ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ì»¨í…Œì´ë„ˆ ìŠ¤í™ ê³¼ ê°™ì€ êµ¬ì¡°ë¥¼ ê°€ì§„ë‹¤. íŠ¹ì • ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì™€ ëª…ë ¹, ê·¸ë¦¬ê³  ì¸ìë¥¼ ì§€ì •í•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤. 

ì•„ë˜ í…œí”Œë¦¿ì€ `docker/whalesay` ì´ë¯¸ì§€ì—ì„œ `hello world` ë¥¼ ì¸ìë¡œ `cowsay` ëª…ë ¹ì„ ì‹¤í–‰í•˜ëŠ” ì˜ˆì´ë‹¤.

```yaml
- name: whalesay
  container:
    image: docker/whalesay
    command: [cowsay]
    args: ["hello world"]
```

#### Script í…œí”Œë¦¿ 

ìŠ¤í¬ë¦½íŠ¸ í…œí”Œë¦¿ì€ ì»¨í…Œì´ë„ˆ í…œí”Œë¦¿ì„ í¸ì˜ìƒ í¬ì¥í•œ ê²ƒìœ¼ë¡œ, ë‹¤ë¥¸ ìŠ¤í™ì€ ë¹„ìŠ·í•˜ë‚˜ `source` ë¸”ëŸ­ì— ì§ì ‘ ì½”ë“œë¥¼ ê¸°ì…í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì´ ë‹¤ë¥´ë‹¤. 

ë‹¤ìŒì€ íŒŒì´ì¬ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì—ì„œ íŒŒì´ì¬ ì½”ë“œë¡œ ëœë¤ê°’ì„ ì¶œë ¥í•˜ëŠ” ì˜ˆì´ë‹¤.

```yaml
- name: gen-random-int
  script:
    image: python:alpine3.6
    command: [python]
    source: |
      import random
      i = random.randint(1, 100)
      print(i)
```

ì‹¤í–‰ ê²°ê³¼ëŠ” ì´í›„ í…œí”Œë¦¿ì—ì„œ `{{tasks.<NAME>.outputs.result}}` ë˜ëŠ” `{{steps.<NAME>.outputs.result}}` ë³€ìˆ˜ë¡œ ì´ìš©í•  ìˆ˜ ìˆë‹¤.

#### Resource í…œí”Œë¦¿ 

ë¦¬ì†ŒìŠ¤ í…œí”Œë¦¿ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì˜ ë¦¬ì†ŒìŠ¤ë¡œ ì§ì ‘ ì‘ì—…ì„ í•˜ëŠ” íƒ€ì…ì´ë‹¤. `get`, `create`, `apply`, `delete`, `replace`, `patch` ë™ì‘ì´ ê°€ëŠ¥í•˜ë‹¤.

ë‹¤ìŒ ì˜ˆëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ `ConfigMap` ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•œë‹¤.

```yaml
- name: k8s-owner-reference
  resource:
    action: create
    manifest: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        generateName: owned-eg-
      data:
        some: value
```

#### Suspend í…œí”Œë¦¿

ì„œìŠ¤íœë“œ í…œí”Œë¦¿ì€ ì£¼ì–´ì§„ ì‹œê°„ë™ì•ˆ, ë˜ëŠ” ìˆ˜ë™ ëª…ë ¹ì´ ìˆì„ ë•Œê¹Œì§€ ì‹¤í–‰ì„ ë©ˆì¶”ê³  ê¸°ë‹¤ë¦¬ëŠ”ë° ì‚¬ìš©ëœë‹¤. CLI ì˜ `argo resume` ëª…ë ¹ìœ¼ë¡œ ì¬ê°œí•  ìˆ˜ ìˆë‹¤.

```yaml
- name: delay
  suspend:
    duration: "20s"
```

### í˜¸ì¶œ í…œí”Œë¦¿

í˜¸ì¶œ (Invocation) í…œí”Œë¦¿ì€ ë‹¤ë¥¸ í…œí”Œë¦¿ì„ í˜¸ì¶œí•˜ì—¬ ì‹¤í–‰ íë¦„ì„ êµ¬ì„±í•œë‹¤. ê° í˜¸ì¶œì€ ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì„±ì„ ê°€ì§„ë‹¤.

```yaml
name:     # ìì‹ ì˜ ì´ë¦„
template: # í˜¸ì¶œí•  í…œí”Œë¦¿ 
arguments: # í…œí”Œë¦¿ì— ë„˜ê¸¸ ë§¤ê°œë³€ìˆ˜
  parameters:  # ì‹¤ì œ ì¸ìê°’
```

#### Steps í…œí”Œë¦¿

í•˜ë‚˜ ì´ìƒì˜ ìŠ¤í…ìœ¼ë¡œ ì‘ì—…ì„ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤. ê° ìŠ¤í…ì€ í˜¸ì¶œì˜ ë¦¬ìŠ¤íŠ¸ë¡œ êµ¬ì„±ëœë‹¤. ê°œë³„ ìŠ¤í…ì€ ì •ì˜ëœ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ë˜ê³ , ìŠ¤í…ë‚´ì˜ í˜¸ì¶œì€ ë³‘ë ¬ë¡œ ì‹¤í–‰ëœë‹¤.

ì•„ë˜ ì˜ˆì—ì„œ `steps` ë¸”ëŸ­ ì•„ë˜ì— ìŠ¤í…ì´ ê¸°ìˆ ë˜ì–´ ìˆë‹¤. `step1` ì´ ì‹¤í–‰ëœ í›„, `step2a` ì™€ `step2b` ê°€ ë™ì‹œì— ì‹¤í–‰ëœë‹¤.

> ìŠ¤í… ë¦¬ìŠ¤íŠ¸ì¸ `steps` ì•„ë˜ í˜¸ì¶œ ë¦¬ìŠ¤íŠ¸ê°€ ê¸°ìˆ ë˜ëŠ” êµ¬ì¡°ì´ê¸°ì— `- -` ë¡œ í‘œê¸°ëœ ê²ƒì— ì£¼ì˜í•˜ì.

```yaml
- name: hello-hello-hello
  steps:
  - - name: step1
      template: prepare-data
  - - name: step2a
      template: run-data-first-half
    - name: step2b
      template: run-data-second-half
```

#### DAG í…œí”Œë¦¿ 

DAG (Directed Acyclic Graph) ëŠ” *ìœ í–¥ ë¹„ìˆœí™˜ ê·¸ë˜í”„* ë¥¼ ë‚˜íƒ€ë‚´ëŠ”ë°, ì›Œí¬í”Œë¡œìš°ë¥¼ êµ¬ì„±í•˜ëŠ” í•˜ìœ„ ì‘ì—… (task) ë“¤ì´ ì˜ì¡´ ê´€ê³„ ê·¸ë˜í”„ë¡œ êµ¬ì„±ë  ë•Œ ìœ ìš©í•˜ë‹¤. 

ì•„ë˜ ì˜ˆì œì²˜ëŸ¼, ì´ëŸ¬í•œ DAG êµ¬ì¡° í…œí”Œë¦¿ ì •ì˜ë¥¼ ìœ„í•´ `dag` ë¸”ëŸ­ì„, í•˜ë¶€ ê³¼ì œì˜ ì˜ì¡´ ê´€ê³„ë¥¼ ê¸°ìˆ í•˜ê¸° ìœ„í•´ `depends` ë¸”ëŸ­ì„ ì´ìš©í•œë‹¤.

```yaml
- name: diamond
  dag:
    tasks:
    - name: A
      template: echo
    - name: B
      dependencies: [A]
      template: echo
    - name: C
      dependencies: [A]
      template: echo
    - name: D
      dependencies: [B, C]
      template: echo
```

ì˜ˆì œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë‹¤ì´ì•„ëª¬ë“œ êµ¬ì¡°ë¥¼ ê°€ì§„ë‹¤.

```  
    A
   / \
  B   C
   \ /
    D
```

ê·¸ë¦¼ì—ì„œ ìµœì¢… ìŠ¤í… Dë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´, B ì™€ C ê°€ í•„ìš”í•˜ê³ , B ì™€ C ê°€ ìˆ˜í–‰ë˜ê¸° ìœ„í•´ì„œëŠ” A ê°€ ë¨¼ì € ìˆ˜í–‰ë˜ì–´ì•¼ í•œë‹¤.

ì´ì œ í˜¸ì¶œ í…œí”Œë¦¿ì„ ì´ìš©í•˜ì—¬ ë™ì‘í•˜ëŠ” ì˜ˆì œë¥¼ ì‚´í´ë³´ê² ë‹¤.

### ë©€í‹° ìŠ¤í… ì›Œí¬í”Œë¡œìš° ì˜ˆì œ

ë‹¤ìŒì€ ì •ì˜ëœ í…œí”Œë¦¿ì„ í•œ ë²ˆ ì´ìƒ ìˆœì°¨ì ìœ¼ë¡œ, ë˜ ë™ì‹œì— í˜¸ì¶œí•˜ì—¬ ì‘ì—…ì„ êµ¬ì„±í•˜ëŠ” ì˜ˆì œì´ë‹¤. ì´ë¥¼ ìœ„í•´ `steps` ë¸”ëŸ­ì„ ì´ìš©í•´ í…œí”Œë¦¿ì„ ì •ì˜í•˜ê³  ìˆë‹¤. ì•„ë˜ ë‚´ìš©ì„ `steps.yaml` íŒŒì¼ë¡œ ì €ì¥í•˜ì.

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: steps-
spec:
  templates:
  # ê³µí†µ í…œí”Œë¦¿ ì •ì˜
  - name: whalesay
    # message íŒ¨ëŸ¬ë¯¸í„°ë¥¼ í…œí”Œë¦¿ ì…ë ¥ìœ¼ë¡œ
    inputs:
      parameters:
      - name: message
    container:
      image: docker/whalesay
      command: [cowsay]
      # í…œí”Œë¦¿ ì…ë ¥ì„ ëª…ë ¹ ì¸ìë¡œ ì‚¬ìš©
      args: ["{{inputs.parameters.message}}"]

  # ê³µí†µ í…œí”Œë¦¿ì„ í˜¸ì¶œí•˜ëŠ” ë©€í‹°ìŠ¤í… í…œí”Œë¦¿
  - name: hello-hello-hello
    steps:
    # 1. hello1
    - - name: hello1
        template: whalesay
        arguments:
          # í…œí”Œë¦¿ ì¸ì
          parameters: [{name: message, value: "hello1"}]
    # 2. hello2a, hello2b
    - - name: hello2a
        template: whalesay
        arguments:
          # í…œí”Œë¦¿ ì¸ì
          parameters: [{name: message, value: "hello2a"}]
      - name: hello2b
        template: whalesay
        arguments:
          # í…œí”Œë¦¿ ì¸ì
          parameters: [{name: message, value: "hello2b"}]
  
  # ë©€í‹° ìŠ¤í… í…œí”Œë¦¿ìœ¼ë¡œ ì‹œì‘
  entrypoint: hello-hello-hello
```

ë‹¤ìŒì²˜ëŸ¼ ì‹¤í–‰í•˜ë©´,

```
argo submit --watch steps.yaml
```

ì•„ë˜ì™€ ê°™ì€ ì¶œë ¥ì´ ë‚˜ì˜¬ ê²ƒì´ë‹¤.

```
Name:                steps-wk5m5
Namespace:           argo
ServiceAccount:      unset (will run with the default ServiceAccount)
Status:              Succeeded
Conditions:
 PodRunning          False
 Completed           True
Created:             Mon Mar 06 18:43:10 +0900 (30 seconds ago)
Started:             Mon Mar 06 18:43:10 +0900 (30 seconds ago)
Finished:            Mon Mar 06 18:43:40 +0900 (now)
Duration:            30 seconds
Progress:            3/3
ResourcesDuration:   18s*(1 cpu),18s*(100Mi memory)

STEP            TEMPLATE           PODNAME                          DURATION  MESSAGE
 âœ” steps-wk5m5  hello-hello-hello
 â”œâ”€â”€â”€âœ” hello1   whalesay           steps-wk5m5-whalesay-1602185977  6s
 â””â”€â”¬â”€âœ” hello2a  whalesay           steps-wk5m5-whalesay-3712874914  9s
   â””â”€âœ” hello2b  whalesay           steps-wk5m5-whalesay-3696097295  6s
```

`hello1` ì´ ë¨¼ì € ì‹¤í–‰ëœ í›„, `hello2a` ì™€ `hello2b` ê°€ ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë³´ì—¬ì£¼ëŠ”ë°, UI ì—ì„œ ì¢€ ë” í™•ì‹¤íˆ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

![Multi step](/assets/2023-03-06-18-46-24.png)

kubectl ë¡œ ë³´ë©´ ê° í…œí”Œë¦¿ í˜¸ì¶œë§ˆë‹¤ íŒŒë“œê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```
$ kubectl get pods 
NAME                                   READY   STATUS      RESTARTS   AGE
argo-server-fb8f5967d-tlqs5            1/1     Running     0          3h54m
steps-wk5m5-whalesay-1602185977        0/2     Completed   0          6m1s
steps-wk5m5-whalesay-3696097295        0/2     Completed   0          5m51s
steps-wk5m5-whalesay-3712874914        0/2     Completed   0          5m51s
workflow-controller-78f7ffdf79-7rctb   1/1     Running     0          3h55m
```

> ì–´ë–¤ íŒŒë“œê°€ ì–´ë–¤ í˜¸ì¶œì— ì†í•˜ëŠ”ì§€ëŠ” íŒŒë“œ ì •ë³´ì˜ `Annotations` ë¸”ëŸ­ì„ ë³´ë©´ ì•Œ ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ë©´ ì•„ë˜ì™€ ê°™ì€ ì‹ì´ë‹¤.
> ```bash
> $ kubectl describe pod steps-wk5m5-whalesay-1602185977
> ...
> Annotations:
>   workflows.argoproj.io/node-name: steps-wk5m5[0].hello1
> ...
> ```

íŒŒë“œì˜ ë¡œê·¸ë¥¼ í™•ì¸í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ê¸°ìˆ ëœ ë§¤ê°œë³€ìˆ˜ë¡œ ê³µìš© í…œí”Œë¦¿ì´ í˜¸ì¶œëœ ê²ƒì„ ì•Œ ìˆ˜ìˆë‹¤.

`hello1` í˜¸ì¶œ ë¡œê·¸
```
 _________
< hello1 >
 ---------
    \
     \
      \
                    ##        .
              ## ## ##       ==
           ## ## ## ##      ===
       /""""""""""""""""___/ ===
  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~
       \______ o          __/
        \    \        __/
          \____\______/
```
`hello2a` í˜¸ì¶œ ë¡œê·¸
```
 _________
< hello2a >
 ---------
    \
     \
      \
                    ##        .
              ## ## ##       ==
           ## ## ## ##      ===
       /""""""""""""""""___/ ===
  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~
       \______ o          __/
        \    \        __/
          \____\______/
```
`hello2b` í˜¸ì¶œ ë¡œê·¸
```
 _________
< hello2b >
 ---------
    \
     \
      \
                    ##        .
              ## ## ##       ==
           ## ## ## ##      ===
       /""""""""""""""""___/ ===
  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~
       \______ o          __/
        \    \        __/
          \____\______/
```

### DAG ì›Œí¬í”Œë¡œìš° ì˜ˆì œ

ì•„ë˜ëŠ” ì•ì„œ ë³¸ ë‹¤ì´ì•„ëª¬ë“œ êµ¬ì¡° ì›Œí¬í”Œë¡œìš°ì˜ ì˜ˆì´ë‹¤. ë©€í‹° ìŠ¤í…ë³´ë‹¤ ë³µì¡í•œ íŠ¸ë¦¬ êµ¬ì¡°ë¥¼ í‘œí˜„í•  ìˆ˜ ìˆë‹¤. DAG êµ¬ì¡° í…œí”Œë¦¿ ì •ì˜ë¥¼ ìœ„í•´ `dag` ë¸”ëŸ­ì„, í˜¸ì¶œì˜ ì˜ì¡´ ê´€ê³„ë¥¼ ê¸°ìˆ í•˜ê¸° ìœ„í•´ `depends` ë¸”ëŸ­ì„ ì´ìš©í•œë‹¤. ë‚´ìš©ì„ `dag-diamond.yaml` íŒŒì¼ë¡œ ì €ì¥í•œë‹¤.

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: dag-diamond-
spec:
  entrypoint: diamond
  templates:
  # ê³µí†µ í…œí”Œë¦¿ ì •ì˜
  - name: echo
    inputs:
      parameters:
      - name: message
    container:
      image: alpine:3.7
      command: [echo, "{{inputs.parameters.message}}"]
  # ê³µí†µ í…œí”Œë¦¿ì„ í˜¸ì¶œí•˜ëŠ” ë©€í‹° ìŠ¤í… í…œí”Œë¦¿ ì •ì˜
  - name: diamond
    dag:
      tasks:
      - name: A
        template: echo
        arguments:
          parameters: [{name: message, value: A}]
      - name: B
        depends: "A"       # A ì— ì˜ì¡´
        template: echo
        arguments:
          parameters: [{name: message, value: B}]
      - name: C
        depends: "A"       # A ì— ì˜ì¡´
        template: echo
        arguments:
          parameters: [{name: message, value: C}]
      - name: D
        depends: "B && C"  # B ì™€ C ì— ì˜ì¡´
        template: echo
        arguments:
          parameters: [{name: message, value: D}]
```

> í•˜ë‚˜ ì´ìƒì˜ ì„ í–‰ í˜¸ì¶œì„ ì˜ì¡´í•˜ëŠ” D ì˜ ê²½ìš° `B && C` í˜•íƒœë¡œ ê¸°ìˆ í•˜ì˜€ë‹¤.
> ì˜ì¡´ ê´€ê³„ë¥¼ ìœ„í•´ ë‹¤ì–‘í•œ ë…¼ë¦¬ ì—°ì‚°ì„ ì§€ì›í•˜ëŠ” ë°, ìì„¸í•œ ê²ƒì€ [ê³µì‹ í˜ì´ì§€](https://argoproj.github.io/argo-workflows/enhanced-depends-logic/) ë¥¼ ì°¸ê³ í•˜ì. 

ë‹¤ìŒì²˜ëŸ¼ ì‹¤í–‰í•˜ë©´,

```
argo submit --watch dag-diamond.yaml
```

ì•„ë˜ì™€ ê°™ì€ ì¶œë ¥ì´ ë‚˜ì˜¬ ê²ƒì´ë‹¤.

```
Name:                dag-diamond-d6xfs
Namespace:           argo
ServiceAccount:      unset (will run with the default ServiceAccount)
Status:              Succeeded
Conditions:
 PodRunning          False
 Completed           True
Created:             Tue Mar 07 12:00:27 +0900 (40 seconds ago)
Started:             Tue Mar 07 12:00:27 +0900 (40 seconds ago)
Finished:            Tue Mar 07 12:01:07 +0900 (now)
Duration:            40 seconds
Progress:            4/4
ResourcesDuration:   16s*(1 cpu),16s*(100Mi memory)

STEP                  TEMPLATE  PODNAME                            DURATION  MESSAGE
 âœ” dag-diamond-d6xfs  diamond
 â”œâ”€âœ” A                echo      dag-diamond-d6xfs-echo-1891072275  8s
 â”œâ”€âœ” B                echo      dag-diamond-d6xfs-echo-1907849894  4s
 â”œâ”€âœ” C                echo      dag-diamond-d6xfs-echo-1924627513  4s
 â””â”€âœ” D                echo      dag-diamond-d6xfs-echo-1941405132  4s
```

ì´ ì¶œë ¥ ë§Œìœ¼ë¡œëŠ” DAGì˜ êµ¬ì¡°ë¥¼ íŒŒì•…í•˜ê¸°ê°€ ì‰½ì§€ ì•Šë‹¤. UI ì—ì„œ ì‚´í´ë³´ë©´ í™•ì‹¤íˆ íŒŒì•…í•  ìˆ˜ ìˆë‹¤.

![Diamond DAG](/assets/2023-03-07-12-03-18.png)

ë‹¤ìŒìœ¼ë¡œëŠ” ì‘ì—…ë“¤ê°„ ê²°ê³¼ë¬¼ì„ ì£¼ê³  ë°›ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ë‹¤.

### ì•„í‹°íŒ©íŠ¸ ì›Œí¬í”Œë¡œìš° ì˜ˆì œ

ë‹¤ìŒ ì˜ˆì œëŠ” ë©€í‹° ìŠ¤í… í˜•íƒœë¡œ, ì²« ìŠ¤í… `generate-artifact` ì—ì„œ ì•„í‹°íŒ©íŠ¸ë¥¼ ìƒì„±í•˜ê³ , ë‹¤ìŒ ìŠ¤í… `print-message` ì—ì„œ ìƒì„±ëœ ì•„í‹°íŒ©íŠ¸ë¥¼ ì´ìš©í•˜ë„ë¡ êµ¬í˜„ë˜ì–´ ìˆë‹¤. ë‚´ìš©ì„ `artifact-passing.yaml` ë¡œ ì €ì¥í•˜ì.

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: artifact-passing-
spec:
  entrypoint: artifact-example
  templates:
  # ì•„í‹°íŒ©íŠ¸ ìƒì„±ìš© ì •ì˜ í…œí”Œë¦¿
  - name: whalesay
    container:
      image: docker/whalesay:latest
      command: [sh, -c]
      args: ["sleep 1; cowsay hello world | tee /tmp/hello_world.txt"]
    # ì¶œë ¥ìœ¼ë¡œ ì‚¬ìš©í•  ì•„í‹°íŒ©íŠ¸
    outputs:
      artifacts:
      # ìƒì„±ëœ /tmp/hello_world.txt íŒŒì¼ì—ì„œ hello-art ì•„í‹°íŒ©íŠ¸ë¥¼ ìƒì„±
      # (ì•„í‹°íŒ©íŠ¸ëŠ” íŒŒì¼ë¿ë§Œ ì•„ë‹ˆë¼ ë””ë ‰í† ë¦¬ í˜•íƒœë„ ê°€ëŠ¥)
      - name: hello-art             # ì¶œë ¥ ì•„í‹°íŒ©íŠ¸ ì´ë¦„ 
        path: /tmp/hello_world.txt  # ì¶œë ¥ ì•„í‹°íŒ©íŠ¸ íŒŒì¼

  # ì•„í‹°íŒ©íŠ¸ í”„ë¦°íŠ¸ìš© ì •ì˜ í…œí”Œë¦¿
  - name: print-message
    # ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©í•  ì•„í‹°íŒ©íŠ¸
    inputs:
      artifacts:
      # ì „ë‹¬ë°›ì€ ì•„í‹°íŒ©íŠ¸ë¥¼ í’€ì–´ì„œ /tmp/message íŒŒì¼ì— ì €ì¥
      - name: message       # ì…ë ¥ ì•„í‹°íŒ©íŠ¸ ì´ë¦„ 
        path: /tmp/message  # ì…ë ¥ ì•„í‹°íŒ©íŠ¸ íŒŒì¼
    container:
      image: alpine:latest
      # ì•„í‹°íŒ©íŠ¸ì—ì„œ í’€ë¦° íŒŒì¼ í”„ë¦°íŠ¸
      command: [sh, -c]
      args: ["cat /tmp/message"]

  # ë©€í‹°ìŠ¤í… í˜¸ì¶œ í…œí”Œë¦¿
  - name: artifact-example
    steps:
    # 1. ì•„íŠ¸íŒ©íŠ¸ ìƒì„± í˜¸ì¶œ
    - - name: generate-artifact
        template: whalesay
    # 2. ì•„í‹°íŒ©íŠ¸ í”„ë¦°íŠ¸ í˜¸ì¶œ
    - - name: consume-artifact
        template: print-message
        arguments:
          artifacts:
          # ìƒì„± í˜¸ì¶œì—ì„œ ìƒì„±ëœ hello-art ì•„í‹°íŒ©íŠ¸ë¥¼ í”„ë¦°íŠ¸ í…œí”Œë¦¿ì˜ ì…ë ¥ ì•„í‹°íŒ©íŠ¸ë¡œ ë°”ì¸ë”© 
          - name: message
            from: "{{steps.generate-artifact.outputs.artifacts.hello-art}}"
```

ë‹¤ìŒì²˜ëŸ¼ ì‹¤í–‰í•˜ë©´,

```
argo submit --watch artifact-passing.yaml  
```

ë‹¤ìŒê³¼ ê°™ì€ ì¶œë ¥ì´ ë‚˜ì˜¬ ê²ƒì´ë‹¤.

```
Name:                artifact-passing-j4rfp
Namespace:           default
ServiceAccount:      unset (will run with the default ServiceAccount)
Status:              Succeeded
Conditions:
 PodRunning          False
 Completed           True
Created:             Wed Mar 08 14:06:55 +0900 (31 seconds ago)
Started:             Wed Mar 08 14:06:55 +0900 (31 seconds ago)
Finished:            Wed Mar 08 14:07:26 +0900 (now)
Duration:            31 seconds
Progress:            2/2
ResourcesDuration:   12s*(1 cpu),12s*(100Mi memory)

STEP                       TEMPLATE          PODNAME                                          DURATION  MESSAGE
 âœ” artifact-passing-j4rfp  artifact-example
 â”œâ”€â”€â”€âœ” generate-artifact   whalesay          artifact-passing-j4rfp-whalesay-1776896446       5s
 â””â”€â”€â”€âœ” consume-artifact    print-message     artifact-passing-j4rfp-print-message-4173331406  8s
```

UI ì—ì„œ ì‚´í´ë³´ë©´ ìƒì„±ëœ ì•„í‹°íŒ©íŠ¸ `hello-art.tgz` ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![Artifact Flow](/assets/2023-03-08-14-08-01.png)

> ì•„í‹°íŒ©íŠ¸ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `tar+gzip` íŒŒì¼ë¡œ ì••ì¶•ë˜ëŠ”ë°, í•„ìš”ì— ë”°ë¼ ì••ì¶• ì„¤ì •ì„ ë°”ê¿€ ìˆ˜ ìˆë‹¤.

## ë¡œì»¬ íŒŒì¼ ETL ì˜ˆì œ

## S3 íŒŒì¼ ETL ì˜ˆì œ 

## FTP íŒŒì¼ ETL ì˜ˆì œ 

### ì»¤ìŠ¤í…€ ì„¼ì„œ ë§Œë“¤ê¸°

## ì˜ˆì™¸ì ì¸ ìƒí™© ëŒ€ì‘

- íŒŒì¼ì´ ì§€ì—°ë˜ì–´ ì˜¬ë¼ì˜¤ëŠ” ê²½ìš°
- íŒŒì¼ì´ ë¶ˆì™„ì „í•˜ê²Œ ì˜¬ë¼ì˜¨ í›„, ì´í›„ ì™„ì „í•œ íŒŒì¼ì´ ë‹¤ì‹œ ì˜¬ë¼ì˜¤ëŠ” ê²½ìš°


## ëìœ¼ë¡œ

### ì°¸ê³  ë§í¬

https://argoproj.github.io/argo-events/
https://github.com/argoproj/argo-events
https://argoproj.github.io/argo-workflows/
https://github.com/argoproj/argo-workflows
https://coffeewhale.com/kubernetes/workflow/argo/2020/02/14/argo-wf/
